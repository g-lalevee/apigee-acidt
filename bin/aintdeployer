#!/bin/bash


set -e

export AINTDEPLOYER_ROOT=$( (cd "$(dirname "$0")" && cd .. && pwd ))
source "$AINTDEPLOYER_ROOT/lib/logutils.sh"

print_usage() {
    cat << EOF
usage: AINTDEPLOYER COMMAND  -o ORG -t TOKEN [options]

Apigee AINTDEPLOYER utility.

Commands:
download
create
list
publish
delete

Options:

-f,--file, integration file name
-n,--name, integration name (to be downloaded or created)
-o,--organization, Apigee organization name (GCP project id or GCP project number)
-r, --region, Apigee Integration target region
-t,--token, GCP token 
--debug, show verbose debug output
--description, Human friendly integration description
EOF
}

CMD_TYPE="$1"

if [ -z "$CMD_TYPE" ] || [ "$CMD_TYPE" = "help" ]; then
    print_usage
    exit 0
elif [ -z "$CMD_TYPE" ] || [ ! -f "$AINTDEPLOYER_ROOT"/cmd/"$CMD_TYPE"/"$CMD_TYPE".sh ];then
    logerror "Please provide a valid command"
    exit 1
fi

for dependency in jq 
do
  if ! [ -x "$(command -v $dependency)" ]; then
    >&2 logfatal "Required command is not on your PATH: $dependency."
    >&2 logfatal "Please install it before you continue."
    exit 2
  fi
done

shift 1
posArgs=()

while [ "$#" -gt 0 ]; do
  case "$1" in
    -d) export directory="$2"; shift 2;;
    -o) export organization="$2"; shift 2;;
    -t) export token="$2"; shift 2;;

    --debug) export debug="T"; shift 1;;
    --description) export description="${2}"; shift 2;;
    --file) export file="${2}"; shift 2;;
    --name) export name="${2}"; shift 2;;
    --project) export organization="${2}"; shift 2;;
    --region) export region="${2}"; shift 2;;
    --token) export token="${2}"; shift 2;;

    -*) logfatal "unknown option: $1" >&2; exit 1;;
    *) posArgs+=("$1"); shift 1;;
  esac
done

export token=${token:-$TOKEN}
export organization=${organization:-$APIGEE_X_ORG}

if [[ -z "$token" ]]; then
    logfatal "required  -t GCP access token"
    exit 1
fi

if [[ -z "$region" ]]; then
    region="us"
fi

logdebug "Apigee OAuth2 access token: ${token:0:8}..."

logdebug "AINTDEPLOYER command: $CMD_TYPE"
"$AINTDEPLOYER_ROOT"/cmd/"$CMD_TYPE"/"$CMD_TYPE".sh "${posArgs[@]}"